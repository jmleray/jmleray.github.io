<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Jean-Marie Le Ray — CV (ORCID)</title>

  <!-- Meta description ~155c pour SEO/LLM -->
  <meta name="description" content="CV de Jean-Marie Le Ray, profil ORCID : biographie, expériences, éducation et travaux. Données synchronisées depuis person.xml (ORCID).">

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="profile">
  <meta property="og:title" content="Jean-Marie Le Ray — CV (ORCID)">
  <meta property="og:description" content="Biographie, expériences, éducation et travaux, générés depuis ORCID.">
  <meta property="og:url" content="https://jmleray.github.io/">
  <meta name="twitter:card" content="summary">

  <!-- JSON-LD Person minimal (sera complété dynamiquement) -->
  <script type="application/ld+json" id="ld-person">
  {
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "Jean-Marie Le Ray",
    "url": "https://jmleray.github.io/",
    "identifier": "ORCID:",
    "sameAs": ["https://orcid.org/"]
  }
  </script>

  <!-- Licence (comme sur ton blog) -->
  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/">

  <style>
    :root { --ink:#111; --muted:#6b7280; --accent:#0f766e; }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:#fff;}
    header{padding:32px 20px 8px;max-width:960px;margin:0 auto}
    header h1{margin:0 0 4px;font-size:28px;line-height:1.2}
    header .tag{color:var(--muted)}
    main{max-width:960px;margin:0 auto;padding:8px 20px 40px}
    section{margin:28px 0}
    h2{font-size:20px;margin:0 0 12px;line-height:1.3;border-bottom:1px solid #eee;padding-bottom:6px}
    .item{padding:10px 0;border-bottom:1px dashed #eee}
    .item:last-child{border-bottom:none}
    .title{font-weight:600}
    .sub{color:var(--muted)}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .chip{border:1px solid #e5e7eb;border-radius:999px;padding:2px 10px;font-size:12px;color:#374151}
    .muted{color:var(--muted)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .small{font-size:13px}
    footer{max-width:960px;margin:0 auto;padding:20px;color:var(--muted);border-top:1px solid #eee}
    .skeleton{background:linear-gradient(90deg,#f3f4f6, #e5e7eb, #f3f4f6);background-size:200% 100%;animation:shimmer 1.2s linear infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .loading{height:14px;border-radius:4px;margin:6px 0}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <h1 id="name" class="skeleton loading" style="width:320px"></h1>
    <div id="orcid" class="tag small skeleton loading" style="width:180px"></div>
  </header>

  <main>
    <section id="bio-sec" class="hidden">
      <h2>Biographie</h2>
      <p id="bio"></p>
    </section>

    <section id="exp-sec" class="hidden">
      <h2>Expériences</h2>
      <div id="exp"></div>
    </section>

    <section id="edu-sec" class="hidden">
      <h2>Éducation</h2>
      <div id="edu"></div>
    </section>

    <section id="works-sec" class="hidden">
      <h2>Travaux / Publications</h2>
      <div id="works"></div>
    </section>
  </main>

  <footer class="small">
    Données : <code>person.xml</code> (ORCID). — Licence : <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. — Site : <a href="https://jmleray.github.io/">jmleray.github.io</a>.
  </footer>

  <script>
  // Utilitaires
  const $ = sel => document.querySelector(sel);
  const show = id => $(id).classList.remove('hidden');
  const text = (node, val) => { node.textContent = val; node.classList.remove('skeleton','loading'); };

  // Récupère le texte d’un nœud si présent (par nom local, ORCID XML varie selon namespace)
  const firstText = (root, names) => {
    for (const n of names) {
      const el = root.getElementsByTagName(n)[0] || root.querySelector(n);
      if (el && (el.textContent || el.getAttribute && el.getAttribute('path'))) {
        return el.textContent || el.getAttribute('path');
      }
    }
    return '';
  };

  // Lecture du fichier ORCID
  fetch('person.xml', {cache:'no-store'})
    .then(r => r.text())
    .then(xmlStr => new window.DOMParser().parseFromString(xmlStr, 'application/xml'))
    .then(doc => {
      // Certains dumps ORCID sont <record:record> → la “personne” est sous <person:person> ou <person>
      const person = doc.querySelector('person, person\\:person, record\\:person') || doc;

      // Nom
      const given = firstText(person, ['given-name','personal-details:given-name']);
      const family = firstText(person, ['family-name','personal-details:family-name']);
      const credit = firstText(person, ['credit-name','personal-details:credit-name']);
      const fullName = (credit || [given, family].filter(Boolean).join(' ')).trim();
      text($('#name'), fullName || 'Nom indisponible');

      // ORCID iD (dans record:orcid-identifier > path)
      let orcid = '';
      const idNode = person.querySelector('orcid-identifier, common\\:orcid-identifier, record\\:orcid-identifier');
      if (idNode) {
        const path = firstText(idNode, ['path']);
        if (path) orcid = `https://orcid.org/${path}`;
      }
      const orcidEl = $('#orcid');
      orcidEl.innerHTML = orcid ? `<a href="${orcid}">${orcid}</a>` : 'ORCID indisponible';
      orcidEl.classList.remove('skeleton','loading');

      // Bio
      const bio = firstText(person, ['biography','person:biography','record:biography']).trim();
      if (bio) { $('#bio').textContent = bio; show('#bio-sec'); }

      // Emplois (employment-summary)
      const expWrap = $('#exp');
      const employments = doc.querySelectorAll('employment-summary, activities\\:employment-summary');
      if (employments.length) {
        employments.forEach(e => {
          const org = firstText(e, ['organization-name','common:organization-name']);
          const role = firstText(e, ['role-title','common:role-title']);
          const city = firstText(e, ['city']);
          const region = firstText(e, ['region']);
          const startY = firstText(e, ['start-date year','start-date > year']);
          const endY = firstText(e, ['end-date year','end-date > year']);
          const dates = (startY || endY) ? `${startY || '…'} – ${endY || 'présent'}` : '';
          const line = `
            <div class="item">
              <div class="title">${role || 'Rôle'}</div>
              <div class="sub">${[org, [city, region].filter(Boolean).join(', ')].filter(Boolean).join(' — ')}</div>
              <div class="muted small">${dates}</div>
            </div>`;
          expWrap.insertAdjacentHTML('beforeend', line);
        });
        show('#exp-sec');
      }

      // Éducation (education-summary)
      const eduWrap = $('#edu');
      const edus = doc.querySelectorAll('education-summary, activities\\:education-summary');
      if (edus.length) {
        edus.forEach(e => {
          const org = firstText(e, ['organization-name','common:organization-name']);
          const degree = firstText(e, ['degree','education:degree','qualification']);
          const startY = firstText(e, ['start-date year','start-date > year']);
          const endY = firstText(e, ['end-date year','end-date > year']);
          const dates = (startY || endY) ? `${startY || '…'} – ${endY || 'présent'}` : '';
          const line = `
            <div class="item">
              <div class="title">${degree || 'Diplôme / Formation'}</div>
              <div class="sub">${org || ''}</div>
              <div class="muted small">${dates}</div>
            </div>`;
          eduWrap.insertAdjacentHTML('beforeend', line);
        });
        show('#edu-sec');
      }

      // Travaux (work-summary)
      const worksWrap = $('#works');
      const works = doc.querySelectorAll('work-summary, activities\\:work-summary');
      if (works.length) {
        works.forEach(w => {
          const title = firstText(w, ['title','work:title','common:title']).trim();
          const year = firstText(w, ['publication-date year','publication-date > year']);
          // external-id:value pour DOI/arXiv/etc.
          let doi = '';
          w.querySelectorAll('external-id, common\\:external-id').forEach(x => {
            const type = firstText(x, ['external-id-type']).toLowerCase();
            const val = firstText(x, ['external-id-value']);
            if (!doi && (type.includes('doi'))) doi = `https://doi.org/${val}`;
          });
          const journal = firstText(w, ['journal-title','work:journal-title']);
          const line = `
            <div class="item">
              <div class="title">${title || 'Titre indisponible'}</div>
              <div class="sub">${[journal, year].filter(Boolean).join(' • ')}</div>
              ${doi ? `<div class="small"><a href="${doi}">DOI</a></div>` : ''}
            </div>`;
          worksWrap.insertAdjacentHTML('beforeend', line);
        });
        show('#works-sec');
      }

      // Met à jour dynamiquement le JSON-LD avec les infos ORCID récupérées
      try {
        const ld = JSON.parse(document.getElementById('ld-person').textContent);
        if (fullName) ld.name = fullName;
        if (orcid) {
          ld.identifier = `ORCID:${orcid.replace('https://orcid.org/','')}`;
          ld.sameAs = Array.from(new Set([...(ld.sameAs||[]), orcid]));
        }
        document.getElementById('ld-person').textContent = JSON.stringify(ld);
      } catch(e){ /* silencieux */ }

    })
    .catch(err => {
      text($('#name'), 'Jean-Marie Le Ray');
      text($('#orcid'), 'ORCID non chargé');
      console.error('Erreur lecture person.xml', err);
    });
  </script>
</body>
</html>
