<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jean-Marie Le Ray — ORCID</title>

  <!-- Meta SEO courte (150–160c) -->
  <meta name="description" content="CV ORCID de Jean-Marie Le Ray : bio, mots-clés, emplois, études et publications, générés automatiquement depuis person.xml. Licence CC BY 4.0." />
  <meta name="robots" content="index,follow" />
  <meta name="format-detection" content="telephone=no" />
  <link rel="license" href="https://creativecommons.org/licenses/by/4.0/" />

  <style>
    :root { --fg:#111; --muted:#666; --link:#0a58ca; --bg:#fff; --card:#f6f7f9; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    .container{max-width:860px;margin:40px auto;padding:0 20px}
    header{margin-bottom:24px}
    h1{font-size:clamp(1.6rem,3vw,2.2rem);margin:0 0 6px 0}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:.2rem .5rem;border-radius:.5rem;background:#eef;border:1px solid #ccd;margin:.15rem .25rem 0 0;font-size:.85rem}
    section{background:var(--card);border:1px solid #e6e8eb;border-radius:12px;padding:16px 18px;margin:18px 0}
    h2{font-size:1.15rem;margin:.1rem 0 .6rem}
    ul{margin:.4rem 0 0 1.1rem}
    li+li{margin-top:.35rem}
    .grid{display:grid;gap:10px}
    .two{grid-template-columns:1fr 1fr}
    footer{margin:28px 0 18px}
    code.small{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Liberation Mono",Consolas,monospace;font-size:.85rem;background:#f2f3f5;padding:.15rem .35rem;border-radius:.35rem}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="name">Jean-Marie Le Ray</h1>
      <div class="muted" id="strap">ORCID non chargé</div>
      <div class="muted" style="margin-top:6px">
        Données : <code class="small">data/person.xml</code> (ORCID) — Licence : <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> — Site : <a href="https://jmleray.github.io">jmleray.github.io</a>
      </div>
    </header>

    <section id="bioBox" class="hidden">
      <h2>Bio</h2>
      <div id="bio"></div>
    </section>

    <section id="keywordsBox" class="hidden">
      <h2>Mots-clés</h2>
      <div id="keywords"></div>
    </section>

    <section id="employmentBox" class="hidden">
      <h2>Emplois</h2>
      <ul id="employment"></ul>
    </section>

    <section id="educationBox" class="hidden">
      <h2>Études</h2>
      <ul id="education"></ul>
    </section>

    <section id="worksBox" class="hidden">
      <h2>Publications / Travaux</h2>
      <ul id="works"></ul>
    </section>

    <footer class="muted">
      Généré côté client à partir d’ORCID XML. Aucun suivi, aucun cookie.
    </footer>
  </div>

  <script>
    // -------- Helpers namespace-agnostic (ignore les prefixes ORCID) ----------
    const byLocal = (node, local) => {
      // Renvoie tous les descendants dont le localName (sans namespace) correspond
      const out = [];
      const walker = document.createTreeWalker(node, NodeFilter.SHOW_ELEMENT, {
        acceptNode(el) { return (el.localName === local) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_SKIP; }
      });
      let n; while ((n = walker.nextNode())) out.push(n);
      return out;
    };
    const firstLocal = (node, local) => byLocal(node, local)[0] || null;
    const text = (el) => (el && el.textContent || '').trim();
    const yearOf = (parent, tag) => {
      const y = firstLocal(parent, 'year');
      return y ? text(y) : '';
    };

    // -------- Rendu simple ----------
    const show = (id) => document.getElementById(id).classList.remove('hidden');
    const set = (id, html) => { const n = document.getElementById(id); n.innerHTML = html; if (html.trim()) show(id + 'Box'); };

    // -------- Parse ORCID XML ----------
    async function loadORCID() {
      try {
        const res = await fetch('data/person.xml', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const str = await res.text();

        const doc = new DOMParser().parseFromString(str, 'application/xml');

        // Nom
        const person = firstLocal(doc, 'person') || doc;
        const given = text(firstLocal(person, 'given-names')) || '';
        const family = text(firstLocal(person, 'family-name')) || '';
        const creditName = text(firstLocal(person, 'credit-name')) || '';
        const displayName = creditName || [given, family].filter(Boolean).join(' ') || 'Nom ORCID';
        document.getElementById('name').textContent = displayName;

        // ORCID iD
        const pathEl = firstLocal(doc, 'path');
        const orcidId = pathEl ? ('https://orcid.org/' + text(pathEl)) : '';
        document.getElementById('strap').innerHTML = orcidId
          ? `Profil ORCID : <a href="${orcidId}" rel="me">${orcidId}</a>`
          : 'Profil ORCID';

        // Bio
        const bio = text(firstLocal(person, 'biography'));
        if (bio) set('bio', bio);

        // Keywords
        const kwRoot = firstLocal(person, 'keywords');
        if (kwRoot) {
          const kws = byLocal(kwRoot, 'keyword')
    .map(k => k.childNodes.length ? [...k.childNodes].map(n => n.nodeType === 3 ? n.nodeValue.trim() : '').join('') : '')
    .map(t => t.trim())
    .filter(t => t.length > 0);
  if (kws.length) {
    document.getElementById('keywords').innerHTML =
      kws.map(k => `<span class="badge">${k}</span>`).join(' ');
    show('keywordsBox');
          }
        }

        // Emplois (employment-summary)
        const employments = byLocal(doc, 'employment-summary');
        if (employments.length) {
          const items = employments.map(e => {
            const org = firstLocal(e, 'organization');
            const orgName = org ? text(firstLocal(org, 'name')) : '';
            const role = text(firstLocal(e, 'role-title'));
            const start = firstLocal(e, 'start-date'), end = firstLocal(e, 'end-date');
            const ys = start ? yearOf(start, 'year') : '';
            const ye = end ? yearOf(end, 'year') : '';
            const period = (ys || ye) ? ` (${ys || '…'}–${ye || '…'})` : '';
            return (orgName || role) ? `<li><strong>${orgName || role}</strong>${role && orgName ? ' — ' + role : ''}${period}</li>` : '';
          }).filter(Boolean).join('');
          if (items) { document.getElementById('employment').innerHTML = items; show('employmentBox'); }
        }

        // Études (education-summary)
        const educations = byLocal(doc, 'education-summary');
        if (educations.length) {
          const items = educations.map(e => {
            const org = firstLocal(e, 'organization');
            const orgName = org ? text(firstLocal(org, 'name')) : '';
            const role = text(firstLocal(e, 'role-title')) || text(firstLocal(e, 'department-name')); // parfois degree/dep
            const start = firstLocal(e, 'start-date'), end = firstLocal(e, 'end-date');
            const ys = start ? yearOf(start, 'year') : '';
            const ye = end ? yearOf(end, 'year') : '';
            const period = (ys || ye) ? ` (${ys || '…'}–${ye || '…'})` : '';
            return (orgName || role) ? `<li><strong>${orgName || role}</strong>${role && orgName ? ' — ' + role : ''}${period}</li>` : '';
          }).filter(Boolean).join('');
          if (items) { document.getElementById('education').innerHTML = items; show('educationBox'); }
        }

        // Travaux (work-summary)
        const works = byLocal(doc, 'work-summary');
        if (works.length) {
          const items = works.map(w => {
            const t = firstLocal(firstLocal(w, 'title') || w, 'title');
            const title = text(t);
            const pub = firstLocal(w, 'publication-date');
            const y = pub ? yearOf(pub, 'year') : '';
            const journal = text(firstLocal(w, 'journal-title'));
            // Identifier externe (DOI/URL)
            let link = '';
            const extIds = byLocal(w, 'external-id');
            for (const id of extIds) {
              const type = text(firstLocal(id, 'external-id-type')).toLowerCase();
              const val = text(firstLocal(id, 'external-id-value'));
              if (type === 'doi' && val) { link = 'https://doi.org/' + val; break; }
              if (type === 'url' && val) { link = val; }
            }
            const meta = [journal, y].filter(Boolean).join(' · ');
            const titleHtml = link ? `<a href="${link}" target="_blank" rel="noopener">${title || '(sans titre)'}</a>` : (title || '(sans titre)');
            return `<li>${titleHtml}${meta ? ` — <span class="muted">${meta}</span>` : ''}</li>`;
          }).slice(0, 50).join(''); // limite prudente
          if (items) { document.getElementById('works').innerHTML = items; show('worksBox'); }
        }

      } catch (err) {
        document.getElementById('strap').textContent = 'Impossible de charger ORCID (' + err.message + ')';
      }
    }

    loadORCID();
  </script>
</body>
</html>
